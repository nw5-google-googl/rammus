<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hexa Cars</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <!-- Yandex Games SDK -->
    <script src="/sdk.js"></script>
    <script src="https://app-195179.games.s3.yandex.net/sdk/_/v2.c0ffcbe656dd5022e92c.js"></script>
</head>
<body class="dark">
    <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas" style="background: url('Build/YD_HexaCars.jpg') center center / cover; cursor: default;" width="2049" height="1108"></canvas>
    </div>
    <div id="loading-cover" style="display: none;">
        <div id="unity-loading-bar">
            <div id="unity-logo"><img src="logo.png"></div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full" style="width: 100%;"></div>
            </div>
            <div class="spinner" style="display: none;"></div>
        </div>
    </div>
    <script>
        const hideFullScreenButton = "";
        const buildUrl = "Build";
        const loaderUrl = buildUrl + "/YD_HexaCars.loader.js";
        const config = {
            dataUrl: buildUrl + "/YD_HexaCars.data.unityweb",
            frameworkUrl: buildUrl + "/YD_HexaCars.framework.js.unityweb",
            codeUrl: buildUrl + "/YD_HexaCars.wasm.unityweb",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "RHM Interactive",
            productName: "Hexa Cars",
            productVersion: "1.0",
            webglContextAttributes: {
                preserveDrawingBuffer: true,
                powerPreference: "high-performance",
            },
        };

        const container = document.querySelector("#unity-container");
        const canvas = document.querySelector("#unity-canvas");
        const loadingCover = document.querySelector("#loading-cover");
        const progressBarEmpty = document.querySelector("#unity-progress-bar-empty");
        const progressBarFull = document.querySelector("#unity-progress-bar-full");
        const spinner = document.querySelector('.spinner');

        const canFullscreen = (() => {
            for (const key of [
                'exitFullscreen',
                'webkitExitFullscreen',
                'webkitCancelFullScreen',
                'mozCancelFullScreen',
                'msExitFullscreen',
            ]) {
                if (key in document) {
                    return true;
                }
            }
            return false;
        })();

        if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
            container.className = "unity-mobile";
            //config.devicePixelRatio = 1;
        }
        canvas.style.background = "url('" + buildUrl + "/YD_HexaCars.jpg') center / cover";
        loadingCover.style.display = "";

        let StartUnityInstance;
        let myGameInstance = null;
        let ysdk = null;
        let leaderboard;
        let payments = null;
        let initGame = false;
        let nowFullAdOpen = false;
        let getPlayer = false;

        const script = document.createElement("script");
        script.src = loaderUrl;
        script.onload = () => {
            createUnityInstance(canvas, config, (progress) => {
                spinner.style.display = "none";
                progressBarEmpty.style.display = "";
                progressBarFull.style.width = `${100 * progress}%`;
            }).then((unityInstance) => {
                myGameInstance = unityInstance;
                loadingCover.style.display = "none";
            }).catch((message) => {
                alert(message);
            });
        };

        YaGames.init({
            adv: {
                onAdvClose: wasShown => {
                    console.info('adv closed!');
                }
            }
        }).then(ysdkInstance => {
            ysdk = ysdkInstance;
            ysdk.adv.showFullscreenAdv();
            window.ysdk = ysdk;
        });

        function initPlayer(photoSize, _scopes) {
            if (!ysdk) {
                console.error('Yandex SDK not initialized.');
                return;
            }

            ysdk.getPlayer({ scopes: _scopes }).then(_player => {
                let player = _player;
                let playerName = player.getName();
                let playerPhoto = player.getPhoto(photoSize);

                if (!_scopes) {
                    playerName = "anonymous";
                    playerPhoto = "null";
                }

                if (player.getMode() === 'lite') {
                    NotAuthorized();
                } else {
                    console.log('auth ok');
                    var authJson = { "playerAuth": "resolved", "playerName": playerName, "playerId": player.getUniqueID(), "playerPhoto": playerPhoto };
                    myGameInstance.SendMessage('YandexGame', 'SetAuthorization', JSON.stringify(authJson));
                }
            }).catch(err => {
                console.log('auth err', err);
                NotAuthorized();
            });
        }

        function NotAuthorized() {
            console.log('auth failed');
            var authJson = { "playerAuth": "rejected", "playerName": "unauthorized", "playerId": "", "playerPhoto": "null" };
            myGameInstance.SendMessage('YandexGame', 'SetAuthorization', JSON.stringify(authJson));
        }

        function AuthorizationCheck(photoSize, scopes) {
            initPlayer(photoSize, scopes);
        }

        function OpenAuthDialog(photoSize, scopes) {
            if (!ysdk) {
                console.error('Yandex SDK not initialized.');
                return;
            }

            ysdk.auth.openAuthDialog().then(() => {
                initPlayer(photoSize, scopes);
            }).catch(() => {
                AuthorizationCheck(photoSize, scopes);
            });
        }

        function SaveCloud(jsonData, flush) {
            if (!ysdk || !player) {
                console.error('Yandex SDK or Player not initialized.');
                return;
            }

            player.setData({
                saves: [jsonData],
            }, flush).then(() => {
                console.log('Cloud saves are installed');
            });
        }

        function LoadCloud() {
            if (!ysdk || !player) {
                console.error('Yandex SDK or Player not initialized.');
                return;
            }

            player.getData(["saves"]).then(data => {
                if (data.saves) {
                    myGameInstance.SendMessage('YandexGame', 'SetLoadSaves', JSON.stringify(data.saves));
                } else {
                    ResetProgress();
                }
            }).catch(() => {
                console.log('load err');
            });
        }

        function ResetProgress() {
            myGameInstance.SendMessage('YandexGame', 'ResetSaveCloud');
        }

        function InitLeaderboard() {
            if (!ysdk) {
                console.error('Yandex SDK not initialized.');
                return;
            }

            ysdk.getLeaderboards().then(_lb => {
                leaderboard = _lb;
                myGameInstance.SendMessage('YandexGame', 'InitializedLB');
            });
        }

        function SetLeaderboardScores(_name, score) {
            if (!ysdk || !leaderboard) {
                console.error('Yandex SDK or Leaderboard not initialized.');
                return;
            }

            leaderboard.setLeaderboardScore(_name, score);
        }

        function GetLeaderboardScores(nameLB, maxPlayers, quantityTop, quantityAround, photoSize, auth) {
            if (!ysdk || !leaderboard) {
                console.error('Yandex SDK or Leaderboard not initialized.');
                return;
            }

            const fetchEntries = (entries) => {
                EntriesLB(entries, nameLB, maxPlayers, photoSize);
            };

            if (auth) {
                leaderboard.getLeaderboardEntries(nameLB, { quantityTop, includeUser: true, quantityAround }).then(fetchEntries);
            } else {
                leaderboard.getLeaderboardEntries(nameLB, { quantityTop }).then(fetchEntries);
            }
        }

        function EntriesLB(res, nameLB, maxPlayers, photoSize) {
            console.log(res);
            let playersCount = Math.min(res.entries.length, maxPlayers);
            let rank = [];
            let photo = [];
            let playersName = [];
            let scorePlayers = [];

            for (let i = 0; i < playersCount; i++) {
                let entry = res.entries[i];
                rank[i] = entry.rank;
                scorePlayers[i] = entry.score;

                photo[i] = photoSize === 'nonePhoto' || entry.player.scopePermissions.avatar !== "allow" ? 'nonePhoto' : entry.player.getAvatarSrc(photoSize);
                playersName[i] = entry.player.scopePermissions.public_name !== "allow" ? "Anonymous" : entry.player.publicName;
            }

            if (playersCount === 0) {
                console.log('No data');
            }

            let jsonLB = { "nameLB": nameLB, "quantityPlayers": playersCount, "rank": rank, "photo": photo, "playersName": playersName, "scorePlayers": scorePlayers };
            myGameInstance.SendMessage('YandexGame', 'GetEntries', JSON.stringify(jsonLB));
        }

        function Purchase(id) {
            if (!ysdk || !payments) {
                console.error('Yandex SDK or Payments not initialized.');
                return;
            }

            payments.purchase(id).then(product => {
                let json = JSON.stringify(product);
                myGameInstance.SendMessage('YandexGame', 'PurchaseSuccess', json);
            }).catch(err => {
                let json = JSON.stringify(err);
                myGameInstance.SendMessage('YandexGame', 'PurchaseFailed', json);
            });
        }

        function GetPayments() {
            if (!ysdk || !payments) {
                console.error('Yandex SDK or Payments not initialized.');
                return;
            }

            payments.getProducts().then(products => {
                let productsJson = JSON.stringify(products);
                myGameInstance.SendMessage('YandexGame', 'GetPayments', productsJson);
            });
        }

        function GetEnvironment() {
            if (!ysdk) {
                console.error('Yandex SDK not initialized.');
                return;
            }

            let json = JSON.stringify(ysdk.environment);
            myGameInstance.SendMessage('YandexGame', 'GetEnvironment', json);
        }

        document.body.appendChild(script);
    </script>
</body>
</html>
